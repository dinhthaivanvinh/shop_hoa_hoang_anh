const express = require('express');
const router = express.Router();
const multer = require('multer');
const upload = multer({ dest: 'uploads/' });
const { importCSV } = require('../controllers/productsController');
const db = require('../db');
const validatePagination = require('../middlewares/validatePagination');

router.post('/import', upload.single('file'), importCSV);

router.get('/category', validatePagination, async (req, res) => {
  try {
    const { type = 'KhaiTruong' } = req.query;
    const { page, limit, offset } = req.pagination;

    // Truy váº¥n tá»•ng sá»‘ sáº£n pháº©m trÆ°á»›c
    const [[{ total }]] = await db.execute(
      `SELECT COUNT(*) AS total
       FROM products p
       JOIN categories c ON p.category_id = c.id
       WHERE c.name = ?`,
      [type]
    );

    // âœ… Fallback náº¿u offset vÆ°á»£t quÃ¡ tá»•ng
    if (offset >= total) {
      return res.json({
        products: [],
        total,
        page,
        totalPages: Math.ceil(total / limit)
      });
    }

    // Truy váº¥n sáº£n pháº©m
    const sql = `
      SELECT 
        p.id, p.name, p.price, p.description, p.image,
        c.name AS category
      FROM products p
      JOIN categories c ON p.category_id = c.id
      WHERE c.name = ?
      ORDER BY p.id ASC
      LIMIT ${limit} OFFSET ${offset}
    `;

    const [rows] = await db.execute(sql, [type]);

    res.json({
      products: rows,
      total,
      page,
      totalPages: Math.ceil(total / limit)
    });
  } catch (err) {
    console.error('ðŸ”¥ Lá»—i truy váº¥n JOIN:', err);
    res.status(500).json({ error: 'Lá»—i khi láº¥y sáº£n pháº©m theo loáº¡i' });
  }
});

router.get('/home', async (req, res) => {
  try {
    const categories = ['KhaiTruong', 'SinhNhat', 'TangLe'];
    const result = {};

    for (const type of categories) {
      const sql = `
        SELECT 
          p.id, p.name, p.price, p.description, p.image,
          c.name AS category
        FROM products p
        JOIN categories c ON p.category_id = c.id
        WHERE c.name = ?
        ORDER BY p.created_at DESC
        LIMIT 10
      `;
      const [rows] = await db.execute(sql, [type]);
      result[type] = rows;
    }

    res.json(result);
  } catch (err) {
    console.error('ðŸ”¥ Lá»—i khi láº¥y sáº£n pháº©m cho trang Home:', err);
    res.status(500).json({ error: 'Lá»—i server khi láº¥y sáº£n pháº©m trang chá»§' });
  }
});


module.exports = router;
